
# Privilege Escalation Overview

1. what is privesc? 

2. Types of privesc

3. what are local exploits? 


Privilege Escalation is an attack that exploits operating system 
or third party software vulnerabilities (bugs, design, flaws,
etc.) in order to elevate the current access (privileges) to 
protected resources


Privilege escalation can be divided into two types: vertical and
horizontal

# Vertical 

The attacker is able to move from a lower privileged user to a higher privileged user, for example from a low-end user to an 
administrator or root user


# Horizontal

The attacker keeps the same set or level of privileges but
assumes the identity of a different user (they do not gain any
further privilege)



# Local Exploit 

We previously explained client-side and remote exploits, but we 
also intorduced local exploits. Now lets see what these exploits
are 

Different from the other two, local exploits require prior
access on the target system. Their goal is to exploit operating 
systems or application vulerabilities in order to increase
privileges on the target machine



Now that we know more about privilege escalation and local
exploit, let us go back to our pentesting process. The purpose 
of this phase is to provide and secure access to the target
machine with the highest privilege on the machine. In the next 
steps, we will assume to already have a shell or meterpreter 
session on our target

To get some basic information on the current meterpreter
session, we can run sysinfo command. Lets run it and see what we
get

As you can see, we can read about the computer name and the
current OS running on the exploited machine, its architecture, 
domain name and also the architecture of the current meterpreter 
session process 


As you can imagine, there are many other commands and tools that
we can use to get similar or more detailed information. For
example, when dealing with a windows machine we may want to run
systeminfo, while on a linux machine we have plenty of commands 
we can use:

lsb_release
uname
lscpu

and more, we will inspect these later on, once we get a stable
and persistent connection to the exploited machine


Once we know the type of machine we are dealing with, we can
start thinking about our maintaining access activities. In this 
phase we will make sure that our session is: 

1. Stable (Does not get dropped)

2. Privileged 

3. Persistent (through reboots)

One of the main issues when you get a meterpreter session on the 
target, is that the end user can kill the exploited process. It
can happen, for example, when you exploit a client-side vuln
through the web browser and the user just closes the web browser
window 

To avoid losing the session on the target, one of the first tasks
to perform is to migrate the session to another process

Before seesing the migrate command, it is useful to know that
giving the "help" command in meterpreter, or simply typing "?"
and hitting enter, will list all commands and options


Moreover, we have a very useful meterpreter scripts that we can 
execute during this phase of our pentest

We can list them by typing run and then pressing tab twice

Back to our goal of making our session stable. To let metasploit 
automatically migrate to another process, you can use the
following command (on windows)

meterpreter > getpid
Current pid: 2168
meterpreter > run post/windows/manage/migrate

//output would show something like this
Running module against 
Current Server process: 
Spawning notepad.exe process to migrate to 
Succesfully migrated to process


As you can see, the meterpreter script automatically migrates to 
another process. It is important to know that the process on 
which it will migrate will always be a process with the same 
privileges as the current session 

If we want to see the list of all processes running on the
machine we can execute the ps command (even on windows)


We can also run "migrate" directly in the meterpreter session,
but we will have to provide the process ID or process name we
want to migrate to 

It will not automatically create and migrate to a new process


Once we have migrated our session, we can start our
Post-Exploitation process. We will first want to make our access 
to the remote host persistent, in order to come back at any time 
and have access to the machine

However, most of the operations required to achieve a persistent
access, also require our shell to run with the highest
privileges 


# Windows PrivEsc

The easiest way to get higher privileges is to run getsystem 
within meterpreter 

It will automatically find the best technique to elevate
privileges 

By default, the getsystem tries all available techniques to 
escalate privileges. If a technique fails, it will try the next
one until one of the available techniques works

If you want to run a specific technique, simply use the -t
options as follows:

meterpreter > getsystem -t 1


Notice that depending on the current privileges on the machine,
the getsystem command may fail. For example, if you use this 
technique on systems with User Account Control (UAC) enabled
(Windows Vista+), it will not work as well as systems like 
Windows XP

We need to use other techniques to get past this protection and
then be abe to successfully obtain system privileges 

Moreover, we should be aware that getsystem works only against 
Windows OS. For different operating systems, we will have to 
rely on different Metasploit modules 

If you want to know which modules Metasploit offers, you can
navigate the exploit/[os]/local path


When UAC is enabled on the remote system, bypassuac is one of
the modules we can use to bypass it

First of all, we can verify if UAC is enabled by running the
module post/windows/gather/win_privs

If in the result the UAC enabled column is set to true, it means
that the remote system has UAC enabled


What we can do then is use some of the modules offered by 
Metasploit to bypass the UAC protection machanism. We can list 
them by simply searching bypassuac

the steps we will have to do are very easy 

1. Select the bypassuac_vbs module, since it is the newest module

2. Set the session ID on which the module will be executed 

3. Run the module

If the module completes, we will get a new meterpreter session
with the highest priveleges. Remember that this is a bypass, 
so UAC will still be enabled on the target 


We now have admin privileges on the machine, but we do not yet
have the highest privileges. What we can do now is run getsystem 
again in the new meterpreter session. This time it will work 
and we get NT AUTHORITY\SYSTEM

which is the highest windows privileges 



# Incognito Metasploit 

A very powerful meterpreter extension we can use in this phase
is Incognito 

It was a stand-alone tool used to demonstrate security issues 
affecting Windows tokens, but due to its functionality and
features, it has been integrated in Metasploit 

Thanks to incognito, we can impersonate other valid user tokens
on that machine and become that user. the best thing is that we
do not need to know or crack passwords to do this

As you can imagine, being able to switch from one user to
another gives us the possibility to access different local or 
domain resources 

Loading Incognito is very simple. Once we have a meterpreter
session (better with system privileges), we can run the
following command to load the incognito extension:

meterpreter > use incognito 


Now we can list all available tokens with list_tokens or
impersonate other user tokens with impersonate_token

# Unquoted Service Paths

Unquoted Service Paths are another method we can use for either 
persistence on a Windows target, or for escalating our
privileges, depending on the circumstance 

With Unquoted Service Paths vulerabilities, we're able to 
abuse the way that Windows searches for executables belonging 
to a service

In many cases, we can abuse this "search order" to obtain 
persistence to a system as the currently logged-on user or 
escalate our privileges to SYSTEM


The issue arises when a windows service has been configured with 
a path  to a service binary which is unquoted, and additionally, 
contains a space in its path 

When the path to the service binary is unquoted, as in the
example show in the screenshot in the folder, Windows will 
search for the service executable in the following order: 

1. C:\Program.exe

2. C:\Program Files(x86)\Canon\lj.exe

3. C:\Program Files(x86)\Canon\lj Scan Utility\SETEVENT.exe


This gives us two options in regard to an executable we can
drop, and in which directory. In this case C:\Program.exe and 
C:\Program Files(x86)\Canon\lj.exe


Now assuming that our current user would have the necessary 
permissions to write the C:\root, or the Program Files "Canon" 
directory, we could place our own "Program.exe" or "lj.exe" 
files respectively, and when the service starts, it would launch 
our executable, rather than the original "SETEVENT.exe"
executable

Since the affected service runs as SYSTEM, we could have a 
SYSTEM shell in the case the system were to be rebooted, or the 
affected service restarted; In an example where our payload
executable initiates a reverse TCP shell for instance 

There are several different ways we can check for the existance 
of Unqoted Service Paths. We can do it either manually or using 
third-party scripts or tools

One thing we can do is use the WMI Command line tool (wmic) to 
query for all services and paths, specifically searching for 
unquoted paths with the following command line: 

C:\> wmic get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "C:\windows\\" |findstr /i /v """


We can use the "sc" (Service Control) command with the "qc" 
(Show Config) option to query a specific service, and manually 
check for an Unquoted Service path:

C:\> sc qc AdobARMservice

C:\> sc qc CIJSRegister 


Metasploit also contains a module we can use to automatically 
exploit Unquoted Path-Vulnerable instances of services as well 

msf > use exploit/windows/local/trusted_service_path


In the videos and labs accompanying this module, we will see how 
to use privilege escalation techniques on different Windows
OS's, by using both metasploit modules and other tools

We will also try to manually bypass Windows protection
mechanisms in case metasploit is unable to succeed, in addition
to finding and exploiting Unqoted Service Path vulnerabilites 