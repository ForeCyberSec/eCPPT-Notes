

# Mapping the internal network 

In the previous step, we took into account information residing on the local 
victim computer. We will now take a look at the network 


As the name suggests, the main purpose of this step is to map the internal 
organizations network in order to find other exploitable machines to get closer 
to our goal (if any in the specified engagement) 

Since we already have access to at least one internal machine, we can directly 
interact with the target environment (internal network) using it as a bridge

Again, the purpose of this step is to infiltrate and exploit more hosts

this is important when we have to prove that certain areas of the network are 
vulnerable or, when the client wants to verify the exposure of certain
information stored on given devices

While we infiltrate networks, we still have to collect this information:

Network equipment such as firewalls, switches, routers 

Other network hosts and servers - for each of them learn about OS, open ports,
exploitable services and more

Networking protocols and IP addresses

Traffic and data transmitted in the network 



# How to start mapping the Network 


Of course in a real post exploitation process, we do not know the network map
in advance. So lets see how we can figure it out, starting from the exploited
machine 

One of the simplest commands that can help us start drawing the network map is 
"ipconfig" (Windows) or "ifconfig" (Linux). The two commands will display the 
network configuration for each NIC on the machine

meterpreter allows us to run ifconfig even on windows


To print network routes use:

route print (Windows) 

route -v (Linux)


To display the ARP cache use the "arp" command


Although arp may reveal new hosts in the network, another very important command 
to run is "netstat". Netstat allows us to display all the host network
connections, which means listening ports, established connections and also the
process associated with each connection


At this time we have basic information about the network and an exploited machine


We can now move on and start detecting all the other hosts on the internal
network. We will use the exploited machine as the router for our scans. This 
way we can avoid security measures such as firewalls and IDS that may block our 
incoming connections from the external network 


The easiest way to do this is, by running arp_scanner. The script performs an 
ARP scan in the local network and then lists the IP and MAC addresses found

we can get the help manual for this script by using the command: 

run arp_scanner -h 


Although the arp_scanner is very straightforward, we should be aware that
Metasploit offers different modules that we can use to detect alive hosts, open 
ports and more

For example, lets keep going with the alive host detection and run a ping scan on 
the remote network. The module that we are going to use is called ping_sweep and 
it allows us to set the session with which to run the scan



The last script we want to show here is "netenum". Although we wont use it here, 
it offers many useful features and configurations that we should try out



Now that we know the addresses of new potential targets, we can scan them and
check open ports, enabled services, their operating system and so on 


# Pivoting 


Notice that we are not able to directly access these hosts from our machine, 
therefore we will have to tunnel our traffic through the session on the exploited
machine

This technique is called pivoting 


So we know that the target subnet is 10.10.10.0/24, and we want to route all 
traffic to/from this network through the meterpreter session on the exploited
machine 

# This is an extremely important part of our post exploitation process so we need
# to make sure to have a really good understanding of it

To pivot on sessions, we can use two different commands, both setting a new route 
to a new network 

the first one is the following: 

route add 10.10.10.0 255.255.255.0 2

This tells metasploit to route all of the intended traffic for 10.10.10.0/24
through the meterpreter session number 2. In other words, all of the traffic to 
10.10.10.0/24 will be tunneled through our first victim machine 


The second command we can use to add the route is 

meterpreter > run autoroute -s 10.10.10.0/24

Differently from the previous command, this is a script that we have to run
directly from within a meterpreter session. Notice that the results of the two 
commands are the same. All of the traffic intended for 10.10.10.0/24 will be 
routed through the current meterpreter session 

with the route set, we are now able to use the exploited machine (through our
meterpreter session) as a router for our communication with the organizations 
internal network (10.10.10.0/24) 


Now, for example, if we select another metasploit module like 
auxiliary/scanner/portscan/tcp, we can set the RHOSTS to one of the internal
network machines and the scan will be run from the first machine we exploited. We 
can verify this if we analyze the traffic with wireshark 


Once again, remember that this is working only because we add the route to the
target network. Indeed if we flush the routes and try to run the command again, 
we will not obtain any result



So far, we have just scratched the surface of the internal network. We have to
identify all the other hosts first, their services, open ports and so on

Only after the information gathering phase on these hosts is complete, can we 
continue with our penetration test, and repeat the VA phase and the exploitation 
phase. Remember that this is a cyclic process


Sometimes metasploit modules are not enough and we may want to run tools like nmap 
or nesses on these new hosts 

To do this, we will once again use the current session on the exploited machine, to
pivot external tools via the meterpreter session and its routes


In order to do this we will have to set up a socks4 proxy within metasploit and 
then use tools like proxychains to route the traffic through this proxy


The first thing to do, is select and configure the socks4a module on metasploit

This module provides a socks4a proxy server that uses the built-in metasploit 
routing to relay connections 

Once selected, we just need to set the SRVHOST and the SRVPORT parameters, and then 
run the module. In our case, we will leave the address to listen on (SRVHOST) as 
default, but we will change the port to 1080


The last step is to configure tools like proxychains, in order to use the address
and port set in metasploit

Proxychains is a tool that forces any TCP connection made by any given application, 
to follow through proxy's like SOCKS4, SOCKS5, TOR and so on


To configure proxychains, let us open the proxychain.conf file (you can find it in 
/etc), and change the last line as follows: 

[proxylist] 
# add proxy here
# meanwhile
# defaults set to "tor"
socks4 127.0.0.1 1080 

with this line, we are telling proxychains to use SOCKS4 as proxy, on our local
address and port 1080


In other words, we are instructing proxychains to use the proxy set with metasploit
and its routes. The screenshot in the folder shows an example of how the traffic 
will be redirected 


Now that everything is configured, we can use a scanning tool, such as nmap, against
the hosts within the target's internal network. In our tests, we will try to scan
the host 10.10.10.5 

our command will look like the following: 

proxychains nmap -sT -Pn -n 10.10.10.5 --top-ports 50

By adding proxychains before the Nmap scan command, we will force nmap to run
through it


At the end of the scan, we will see our results in our terminal, as if we were
running it normally

If we inspect traffic with wireshark, we would see that there is no traffic between 
our attacker machine's IP and the target



So far we used proxychains to run a portscan on the internal network. It is 
important to understand that thanks to this configuration we are able to route
packets to networks behind NAT configurations or firewalls

Moreover, we can use proxychains in order to establish connections to services
running on machines within the target network 


For example, if one of the machines has services like SSH, telnet, databases and 
so on, we can use the following commands to contact and establish a connection with
it

proxychains ssh <targetIP>

proxychains telnet <targetIP>


In addition to proxychains, we can also use the portfwd command, implemented in 
meterpreter. It allows us to forward connections to specific addresses and ports 
on the remote network 

Therefore, if we want to access a web server, a share or any other service on the 
remote network, we can just set a port forwarding rule through the meterpreter
session, and access it from our local address


For example, the following command will open a listener on our local IP address on 
port 3333 and will forward the connection to the IP address 10.10.10.5 on port 3389

meterpreter > portfwd add -l 3333 -p 3389 -r 10.10.10.5


Once the command runs, we should see a listening connection when we run the command 

netstat -tulpn | grep 3333

The above command should show something similiar to the following: 

tcp        0    0.0.0.0:3333            0.0.0.0:* 


Now that we are sure we are listening for incoming connections on port 3333, we can
try to establish an RDP session with the machine 10.10.10.5

Another diagram example can be found in the folder 

To establish the RDP connection to our local IP address on port 3333 we can run: 

rdesktop 127.0.0.1:3333




At this point of the pentest you should have a more detailed map of the internal
network and its hosts

It is now time to start digging more closely to see if any of the new machines
discovered can be exploited (via our current active meterpreter session on victim 1)
