

# Pillaging aka data harvesting


Pillaging is the step in which you access sensitive data and intellectual
property of the target organization

Demonstrating the feasibility of an external hacker accessing this information
might be the goal of the overall engagement, so this phase is critical


However, according to the type of machine you have compromised, you may or may 
not find what you are looking for. This presents the need to further exploit and
infiltrate the network

Therefore in this step we will also harvest data and information necessary for 
this prupose 


This encompasses getting local information such as files, enumerating
credentials, accounts, IM logs and more, but also network information such as 
internal network blocks in use, domains, intranet servers, shared hard drives, 
repositories and so on

Network information will also be used in the mapping the internal network phase


# important 

Since there is an infinite list of commands that we can run on the target
machines, we will not list all of them here. Instead, we will see the most
important and then we will give some references at the end of the section 

The important thing to remember here is that we need to get as much info as 
we can: system info, applications, services, networks, documents, messaging 
and so on 



We will see a list of scripts and commands here related to data harvesting, that 
a penetration tester could use through a meterpreter session or shell

Notice that we have already seen some of these scripts in previous phases, but
for different purposes. We will still mention them here since they are very
important for the success of this step


# Commands/Scripts 

Let us start harvesting basic information about the system 

with the "sysinfo" command, we are able to get basic information about the
remote system. Notice that the script works both on windows and linux OS's

Another command we can use is "getuid". With this command we can check the user 
that we are running as on the target machine 

Starting with this information, we can already start making assumptions about
the role of the victim machine

For example, if the previous command shows us that the victim machine is a
server, one of the most important things to check is which services are running 
on it

In other words, we have to figure out the role of the machine in the remote
network 


You should try to get answers to questions like: 

Is this a workstation? what department is it from? (R&D, Marketing, etc)

Is this a server? if so then what server (mail, web, a RADIUS, etc)


During the pillaging step, we should be able to give an accurate answer to those 
questions according to the information we get on the system

Let us start uncovering some of the commands we can run to collect more
information 



Let us first run the enum_services scripts and then check how we can get similiar
results from a shell 

meterpreter > run post/windows/gather/enum_services

As we can see, with a single command we get a list of all services on the remote
machine, the user associated with each of them, the startup type and also the 
path to the binary. The same information can be obtained on the machine, by
opening the Services config windows


It is important to know that many post exploitation scripts are implemented as 
modules and can be used outside the meterpreter session 

We just need to select the module with the "use" command, configure its options
with "set", and then excute the module with "run


As we said before, post-exploitation scripts and modules usually contain and 
execute a set of well defined operating system commands. In other words, we can
get similiar results by running the correct commands from a shell on the target 
machine

In the previous case, we can get services information with the "wmic" command


The command we are going to use is: 

# wmic service get Caption,StartName,State,pathname

Another useful command we can use to list services that re currently running is
"net start". Inspecting the results of these commands gives us a better idea of
the machine role. For example, services like DNS or IIS tell us that the
exploited machine has a server role


As you can imagine, these commands rely on the OS we are dealing with

For example, if we want a list of services running on a linux machine, we would 
run: 

service --status-all

In addition to services running on the machine, listing running processes 
could also be very useful to understand the role of the machine. The easiest way
to check them is by running the ps command from meterpreter: 

meterpreter > ps


Some critical information to retrieve in a Windows networked environment, is if 
it is part of a domain, or even, if it is a domain controller

To gather this information we can run the command "net view/domain" or run the 
script enum_domains 

We can also print the list of domain controllers from a shell with the command: 

net group "Domain Controllers /domain


Let us now focus on which commands we can use to get information about users. 
With "net user" (windows) and "cat etc/passwd" (linux) commands, we are able 
to list users on the system 

If the windows machine is part of a domain we can also use scripts like the 
following to enumerate accounts and other info in the default active domain:


meterpreter > run post/windows/gather/enum_ad_users


Similiar information can be obtained with the "net user/domain" command.
Remember that most of the scripts automate and organize information that can be
gathered with shell commands 

Moreover, we can check which groups exist on the machine or which users are
within a group with the command: 

net localgroup <group_name>


The last command we will see is useful to display all the resources shared on
the victim. We can use "net share" from the command prompt or "enum_shares" from
meterpreter 


The list of commands seen here is a small fraction of the ones available in
meterpreter or OS shells 

For example, we did not yet gather networking information such as IP addresses, 
ARP tables, DNS, current connections and so on. In addition to this information, 
we also still need to check installed applications and local files

As we have already seen, we have a number of commands and methods to retrieve
information, depending on the vitctim OS



# Resources for post-exploitation 

https://github.com/mubix/post-exploitation-wiki

https://web.archive.org/web/20150317144317/https:/n0where.net/linux-post-exploitation

http://tim3warri0r.blogspot.com   (windows post-exploit)


It is also useful to know that metasploit implements scripts that automatically
retrieve information from the system. The two main scripts are: 

scraper - harvests system info including network shares, registry hives and 
password hashes 

winenum -retrieves all kinds of info about the system including environment 
variables, network interfaces routing, user accounts and much more


Once we have information about the system, networks, users, groups, services and 
so on, we can start getting not only actual files and documents, but also 
keystrokes

We will look for usernames, passwords, IM logs, private documents and so on 


Metasploit offers some great scripts that could be used in this step. For
example, with the "screenshot" command, we are about to get the screen of the
victim 


# Keylogging 


Another way to get sensitive information from the target is by running a 
keylogger. Although there are many keylogger tools that we can use and install
on the remote machine, metasploit also offers a few scripts to do this: 

keyscan_start and keylogrecorder

It is important to know that depending on the privileges we have on the remote
machine and the process we are attached to, different keystrokes can be logged



For example, if we want to log the credentials typed when the user unlocks the 
screen, we will have to attach the session to the winlogon.exe process (which
runs on SYSTEM). On the other hand, if we want to dump keystrokes while the user
uses applications and so on, we will have to attach to the process explorer.exe 
(which runs on user level) 


# Exfiltration over DNS with lodline (DNS Tunneling)

One method that has been increasingly seen in the wild is the use of DNS for 
data exfiltration, also known as DNS Tunneling

This is a popular method due to the fact that many orgs are not logging or
alerting on anomalous DNS traffic which makes it a go-to vector for exfiltrating 
data out of a target network, and over an often under-monitored "channel"

One tool that can be used for this is known as lodline and can be downloaded
from: 

https://code.kryo.se/iodine/


Not only can lodline help with exfiltrating data from a target environment, but 
it can also help in pen testing engagements that restrict access to the internet
due to authenticated proxies for which we dont have credentials, or can also be 
used for bypassing captive protals, such as commonly seen in wireless networks

In a typical scenario with DNS tunneling, the attacker DNS tunnel client
component initiates a connection to the attacker controlled DNS tunnel server 
component through an organizations DNS server


Once the DNS tunnel is established, the client tansmits all network traffic, 
encoded, and in the form of DNS queries, typically as TXT records, through the
tunnel, which is then decoded at the other end by the server component or 
attacker controlled "DNS Server" 

More info on how this works can be found here: 

http://beta.ivc.no/wiki/index.php/DNS_Tunneling


From there we can trivially tunnel all of our traffic through an SSH socks
server, completely over DNS, bypassing firewalls or any unauthenticated proxies 
along the way


Some pre-requesites for using lodline to create a DNS tunnel for exfiltration 
are:

1. control over a domian name that you own and its DNS configuration, and;

2. An IP address to act as the Authoritative Name Server for your domain name
which you have SSH access to as well 

