

# Mapping the internal network 

In the previous step, we took into account information residing on the local 
victim computer. We will now take a look at the network 


As the name suggests, the main purpose of this step is to map the internal 
organizations network in order to find other exploitable machines to get closer 
to our goal (if any in the specified engagement) 

Since we already have access to at least one internal machine, we can directly 
interact with the target environment (internal network) using it as a bridge

Again, the purpose of this step is to infiltrate and exploit more hosts

this is important when we have to prove that certain areas of the network are 
vulnerable or, when the client wants to verify the exposure of certain
information stored on given devices

While we infiltrate networks, we still have to collect this information:

Network equipment such as firewalls, switches, routers 

Other network hosts and servers - for each of them learn about OS, open ports,
exploitable services and more

Networking protocols and IP addresses

Traffic and data transmitted in the network 



# How to start mapping the Network 


Of course in a real post exploitation process, we do not know the network map
in advance. So lets see how we can figure it out, starting from the exploited
machine 

One of the simplest commands that can help us start drawing the network map is 
"ipconfig" (Windows) or "ifconfig" (Linux). The two commands will display the 
network configuration for each NIC on the machine

meterpreter allows us to run ifconfig even on windows


To print network routes use:

route print (Windows) 

route -v (Linux)


To display the ARP cache use the "arp" command


Although arp may reveal new hosts in the network, another very important command 
to run is "netstat". Netstat allows us to display all the host network
connections, which means listening ports, established connections and also the
process associated with each connection


At this time we have basic information about the network and an exploited machine


We can now move on and start detecting all the other hosts on the internal
network. We will use the exploited machine as the router for our scans. This 
way we can avoid security measures such as firewalls and IDS that may block our 
incoming connections from the external network 


The easiest way to do this is, by running arp_scanner. The script performs an 
ARP scan in the local network and then lists the IP and MAC addresses found

we can get the help manual for this script by using the command: 

run arp_scanner -h 


Although the arp_scanner is very straightforward, we should be aware that
Metasploit offers different modules that we can use to detect alive hosts, open 
ports and more

For example, lets keep going with the alive host detection and run a ping scan on 
the remote network. The module that we are going to use is called ping_sweep and 
it allows us to set the session with which to run the scan



The last script we want to show here is "netenum". Although we wont use it here, 
it offers many useful features and configurations that we should try out



Now that we know the addresses of new potential targets, we can scan them and
check open ports, enabled services, their operating system and so on 


# Pivoting 


Notice that we are not able to directly access these hosts from our machine, 
therefore we will have to tunnel our traffic through the session on the exploited
machine

This technique is called pivoting 


So we know that the target subnet is 10.10.10.0/24, and we want to route all 
traffic to/from this network through the meterpreter session on the exploited
machine 

# This is an extremely important part of our post exploitation process so we need
# to make sure to have a really good understanding of it

To pivot on sessions, we can use two different commands, both setting a new route 
to a new network 

the first one is the following: 

route add 10.10.10.0 255.255.255.0 2

This tells metasploit to route all of the intended traffic for 10.10.10.0/24
through the meterpreter session number 2. In other words, all of the traffic to 
10.10.10.0/24 will be tunneled through our first victim machine 